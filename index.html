<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ç”²é ç´„å–®</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ç°¡å–®çš„ç²‰è‰²ç³»ç¾ç”²é¢¨æ ¼æ¨£å¼ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #fff0f5; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #d63384; margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #666; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus { border-color: #d63384; outline: none; }
        
        /* åœ–ç‰‡ä¸Šå‚³å€å¡Š */
        .file-upload { margin-top: 5px; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; text-align: center; }
        .preview-img { max-width: 100%; margin-top: 10px; border-radius: 8px; display: none; }
        
        button { width: 100%; background-color: #d63384; color: white; border: none; padding: 15px; margin-top: 25px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:disabled { background-color: #ccc; }
        button:active { background-color: #b02a6b; }
        .loading { display: none; text-align: center; margin-top: 10px; color: #d63384; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’… é ç´„ç¾ç”²</h2>
    <form id="bookingForm">
        <label>æ‚¨çš„æš±ç¨±</label>
        <input type="text" id="name" placeholder="è®€å–ä¸­..." readonly>
        <input type="hidden" id="userId"> <label>é ç´„æ—¥æœŸ</label>
        <input type="date" id="date" required>

        <label>é ç´„æ™‚é–“</label>
        <input type="time" id="time" required>

        <label>æœå‹™é …ç›®</label>
        <select id="service" required>
            <option value="" disabled selected>è«‹é¸æ“‡é …ç›®</option>
            <option value="æ‰‹éƒ¨å–®è‰² $1000">æ‰‹éƒ¨å–®è‰² $1000</option>
            <option value="æ‰‹éƒ¨é€ å‹ $1500èµ·">æ‰‹éƒ¨é€ å‹ $1500èµ·</option>
            <option value="è¶³éƒ¨æ·±å±¤ä¿é¤Š $1800">è¶³éƒ¨æ·±å±¤ä¿é¤Š $1800</option>
            <option value="å¸ç”²é‡åš">å¸ç”²é‡åš</option>
        </select>

        <label>åƒè€ƒåœ– (é¸å¡«)</label>
        <div class="file-upload">
            <input type="file" id="fileInput" accept="image/*">
            <img id="preview" class="preview-img" alt="åœ–ç‰‡é è¦½">
        </div>

        <button type="submit" id="submitBtn">é€å‡ºé ç´„</button>
        <div class="loading" id="loadingMsg">è³‡æ–™å‚³é€ä¸­ï¼Œè«‹ç¨å€™...</div>
    </form>
</div>

<script>
    // âš ï¸ è¨­å®šå€ï¼šè«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„è³‡æ–™
    const MY_LIFF_ID = "ä½ çš„_LIFF_ID"; 
    const N8N_WEBHOOK_URL = "https://yunchiao.app.n8n.cloud/webhook-test/reservation"; 

    // åˆå§‹åŒ– LIFF
    liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            // å–å¾—ç”¨æˆ¶è³‡æ–™
            liff.getProfile().then(profile => {
                document.getElementById('name').value = profile.displayName;
                document.getElementById('userId').value = profile.userId;
            });
        }
    });

    // åœ–ç‰‡é è¦½åŠŸèƒ½
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    let base64Image = ""; // ç”¨ä¾†å­˜åœ–ç‰‡ç·¨ç¢¼

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                base64Image = e.target.result; // å­˜å…¥ Base64 å­—ä¸²
            }
            reader.readAsDataURL(file);
        }
    });

    // è¡¨å–®é€å‡ºè™•ç†
    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loadingMsg');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";
        loading.style.display = 'block';

        const data = {
            name: document.getElementById('name').value,
            userId: document.getElementById('userId').value,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            service: document.getElementById('service').value,
            image: base64Image // é€™æ˜¯é‚£ä¸€é•·ä¸²çš„åœ–ç‰‡ç¢¼
        };

        try {
            // å‚³é€è³‡æ–™çµ¦ n8n
            await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // æˆåŠŸå¾Œé—œé–‰è¦–çª—ä¸¦ç™¼é€è¨Šæ¯
            if (liff.isInClient()) {
                await liff.sendMessages([{
                    type: 'text',
                    text: `æˆ‘å·²é€å‡ºé ç´„ï¼\nğŸ“… æ—¥æœŸï¼š${data.date}\nâ° æ™‚é–“ï¼š${data.time}\nğŸ’… é …ç›®ï¼š${data.service}`
                }]);
                liff.closeWindow();
            }
        } catch (error) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
            btn.disabled = false;
            btn.innerText = "é€å‡ºé ç´„";
            loading.style.display = 'none';
        }
    });
</script>

</body>
</html>